---
import { getCollection, render } from "astro:content";
import RootLayout from "../../layouts/root-layout.astro";
import { Image } from "astro:assets";
import { format } from "date-fns";
import readingTime from "reading-time";
import { NAME_VARIATIONS, PRIMARY_NAME, SITE_URL } from "../../lib/seo";

export async function getStaticPaths() {
  const posts = await getCollection("database");

  return posts.map((post) => ({
    params: { slug: post.data.properties.slug.rich_text[0].plain_text },
    props: { post: post },
  }));
}

const { post } = Astro.props;

const { Content } = await render(post);
const title = post.data.properties.title.title[0]?.plain_text ?? "Blog Post";
const coverImage = (post.data.cover as any)?.external?.url;
const digest = (post as any).digest;
const createdAt = digest ? format(new Date(digest), "MMMM d, yyyy") : undefined;
const readStats = readingTime(post.rendered?.html || "");
const readTime = readStats?.text;
const plainDescription = (post.rendered?.html || "")
  .replace(/<[^>]*>/g, " ")
  .replace(/\s+/g, " ")
  .trim();
const description =
  plainDescription.slice(0, 170) ||
  `Read ${title} by ${PRIMARY_NAME} on frontend engineering and web development.`;

const blogPostSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description,
  mainEntityOfPage: `${SITE_URL}${Astro.url.pathname}`,
  url: `${SITE_URL}${Astro.url.pathname}`,
  image: coverImage ? [coverImage] : undefined,
  datePublished: digest ? new Date(digest).toISOString() : undefined,
  dateModified: digest ? new Date(digest).toISOString() : undefined,
  author: {
    "@type": "Person",
    name: PRIMARY_NAME,
    alternateName: NAME_VARIATIONS,
    url: SITE_URL,
  },
};
---

<RootLayout
  title={title}
  description={description}
  ogImage={coverImage}
  type="article"
  structuredData={blogPostSchema}
>
  <article class="">
    {
      coverImage && (
        <div class="relative left-[50%] right-[50%] ml-[-50vw] mr-[-50vw] w-screen h-50 md:h-87.5 bg-muted">
          <Image
            src={coverImage}
            alt={"Cover Image"}
            width={1920}
            height={350}
            class="w-full h-full object-cover transition-opacity duration-500 opacity-0"
            onload="this.classList.remove('opacity-0')"
            loading="lazy"
            decoding="async"
          />
        </div>
      )
    }
    <div class="mdx-content py-6">
      <p class="flex justify-start text-sm">
        {createdAt}
        {readTime && `â€¢ ${readTime}`}
      </p>
      <Content />
    </div>
  </article>
</RootLayout>
